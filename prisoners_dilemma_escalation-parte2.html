<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Escalation Dilemma ‚Äî Part II (Unpredictability)</title>
  <style>
    :root {
      --bg-start: #f5f5f5; --bg-end: #e8e8e8; --text: #134252; --muted: #626c71; --teal: #218d8d; --teal-light: rgba(33, 128, 141, 0.08);
      --green: #26de81; --red: #ff4757; --orange: #ffa502; --deep-red: #c01530; --card: #ffffff; --shadow: 0 12px 32px rgba(0,0,0,0.08); --radius: 12px;
      --s1: 8px; --s2: 12px; --s3: 16px; --s4: 20px; --s5: 24px; --s6: 32px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); background: linear-gradient(180deg, var(--bg-start), var(--bg-end)); min-height: 100vh; }
    a { color: var(--teal); text-decoration: none; }
    .page-shell { max-width: 1200px; margin: 0 auto; padding: var(--s6); }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: var(--s6); border: 1px solid #e0e0e0; }
    .title { font-size: 32px; font-weight: 600; margin: 0 0 var(--s2); color: #134252; }
    .subtitle { font-size: 14px; font-style: italic; color: var(--muted); margin: 0 0 var(--s4); }
    .scenario { background: var(--teal-light); border-left: 3px solid var(--teal); padding: var(--s4); border-radius: var(--radius); margin-bottom: var(--s4); line-height: 1.7; }
    .warning { background: rgba(192, 21, 47, 0.08); border-left: 3px solid var(--deep-red); padding: var(--s4); border-radius: var(--radius); margin-bottom: var(--s5); line-height: 1.6; }
    .btn { width: 100%; padding: var(--s3); border: none; border-radius: 10px; background: var(--teal); color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease; }
    .btn:hover { background: #1a6f78; transform: translateY(-1px); box-shadow: 0 10px 20px rgba(26,111,120,0.2); }
    .btn-secondary { background: white; color: var(--teal); border: 2px solid var(--teal); }
    .btn-secondary:hover { background: rgba(33,141,141,0.08); color: #1a6f78; }
    .grid { display: grid; gap: var(--s4); }
    .game-grid { grid-template-columns: 1fr 1.3fr 1fr; align-items: start; }
    .section-label { font-size: 12px; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; border-bottom: 2px solid var(--teal); padding-bottom: var(--s2); margin-bottom: var(--s3); }
    .history-list { display: flex; flex-direction: column; gap: var(--s2); }
    .history-item { padding: var(--s3); border-radius: var(--radius); border-left: 3px solid #e0e0e0; background: #f5f5f5; line-height: 1.5; font-size: 12px; }
    .history-item strong { color: var(--text); }
    .round-indicator { text-align: center; background: #f0f0f0; padding: var(--s3); border-radius: var(--radius); font-size: 28px; font-weight: 600; color: var(--teal); margin-bottom: var(--s3); }
    .narrative-box { background: white; border: 1px solid #ddd; border-radius: var(--radius); padding: var(--s4); font-size: 14px; line-height: 1.7; color: var(--text); margin-bottom: var(--s3); }
    .choice-btn { width: 100%; padding: var(--s4); text-align: left; border-radius: 10px; border: 2px solid transparent; background: #fff; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease, border 0.2s ease; cursor: pointer; }
    .choice-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
    .choice-btn .icon { font-size: 28px; }
    .choice-btn .title-line { font-size: 16px; font-weight: 600; margin: var(--s2) 0 4px 0; }
    .choice-btn .desc { font-size: 13px; color: var(--text); margin: 0 0 6px 0; }
    .choice-btn .signal { font-size: 12px; font-style: italic; color: var(--muted); margin: 0; }
    .choice-dialogue { border-color: var(--green); }
    .choice-dialogue:hover { background: rgba(38,222,129,0.1); border-color: #20c773; }
    .choice-force { border-color: var(--red); }
    .choice-force:hover { background: rgba(255,71,87,0.1); border-color: #e84352; }
    .choice-selected-dialogue { background: var(--green); color: white; }
    .choice-selected-force { background: var(--red); color: white; }
    .choice-selected-dialogue .desc, .choice-selected-dialogue .signal, .choice-selected-force .desc, .choice-selected-force .signal { color: white; }
    .score-card { background: rgba(33,128,141,0.15); border: 2px solid var(--teal); border-radius: var(--radius); padding: var(--s4); text-align: center; }
    .score-card.red { background: rgba(255,71,87,0.15); border-color: var(--red); }
    .score-label { font-size: 12px; color: var(--muted); margin-bottom: var(--s2); }
    .score-value { font-size: 32px; font-weight: 700; margin: 0; }
    .score-round { font-size: 14px; color: var(--text); margin-top: var(--s2); }
    .insights { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--s3); }
    .insight-box { background: white; border-radius: var(--radius); padding: var(--s4); border-top: 3px solid #ddd; box-shadow: var(--shadow); }
    .what-if { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--s3); margin-top: var(--s4); }
    .end-card { background: white; border-radius: var(--radius); padding: var(--s4); box-shadow: var(--shadow); border: 2px solid #e0e0e0; }
    .end-card.green { border-color: var(--green); background: rgba(38,222,129,0.08); }
    .end-card.red { border-color: var(--red); background: rgba(255,71,87,0.08); }
    .end-card.orange { border-color: var(--orange); background: rgba(255,165,2,0.08); }
    .timeline { background: #f2f2f2; padding: var(--s3); border-radius: var(--radius); text-align: center; font-size: 14px; }
    .outcome-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; z-index: 10; }
    .outcome-content { background: white; border-radius: var(--radius); padding: var(--s5); max-width: 480px; width: 90%; box-shadow: 0 18px 50px rgba(0,0,0,0.2); text-align: center; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; color: white; }
    .status { font-size: 20px; font-weight: 700; margin: var(--s2) 0; }
    .outcome-points { color: var(--muted); margin: var(--s2) 0 var(--s3); }
    .hidden { display: none; }
    .auto-forward { text-align: center; padding: var(--s4); background: rgba(33,141,141,0.1); border-radius: var(--radius); margin-top: var(--s4); }
    .top-nav { display: flex; gap: var(--s3); margin-bottom: var(--s4); font-size: 14px; }
    .top-nav a { color: var(--teal); text-decoration: none; transition: color 0.2s ease; }
    .top-nav a:hover { color: #1a6f78; }
    @media (max-width: 1024px) { .game-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .game-grid { grid-template-columns: 1fr; } .page-shell { padding: var(--s4); } }
    @media (max-width: 480px) { .title { font-size: 26px; } .round-indicator { font-size: 22px; } }
  </style>
</head>
<body>
  <div class="page-shell">
    <div id="start-screen" class="card">
      <div class="top-nav">
        <a href="index.html">‚Üê Home</a>
        <span style="color: var(--muted);">|</span>
        <a href="data-lab.html">‚Üê DataLab</a>
      </div>
      <h1 class="title">The Escalation Dilemma ‚Äî Part II</h1>
      <p class="subtitle">More realistic: noise and unpredictability</p>
      <div class="scenario">
        In Part I, you understood the basics. Now it gets more complex.<br><br>
        In real life, the world is less predictable than the game you just played.<br><br>
        Play 5 more rounds.
      </div>
      <div class="warning">
        Ready to see what happens when things don't go according to plan?
      </div>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: var(--s3); margin-top: var(--s3);">
        <button class="btn" id="begin-btn">Start Part II</button>
        <button class="btn btn-secondary" id="back-part1-btn">Back to Part I</button>
      </div>
    </div>

    <div id="game-screen" class="hidden">
      <div class="card" style="margin-bottom: var(--s4);">
        <div class="round-indicator" id="round-indicator">Round 1 of 5</div>
        <div class="narrative-box" id="narrative-box">
          The situation includes information noise. Although you offered dialogue in the previous round, there is a possibility that Group B will react with force out of fear or misinterpretation.
        </div>
        <div class="grid game-grid">
          <div>
            <div class="section-label">History</div>
            <div class="history-list" id="history-list"></div>
          </div>

          <div>
            <div class="choice-btn choice-dialogue" id="dialogue-btn">
              <div class="icon">üïäÔ∏è</div>
              <div class="title-line" style="color: var(--green);">Dialogue</div>
              <div class="desc">Reach out, attempt negotiation</div>
              <div class="desc">"Group A proposes talks. We show willingness to compromise."
              </div>
              <p class="signal">Signal: we want peace (but they may distrust)</p>
            </div>
            <div style="height: var(--s3);"></div>
            <div class="choice-btn choice-force" id="force-btn">
              <div class="icon">‚ö°</div>
              <div class="title-line" style="color: var(--red);">Show Force</div>
              <div class="desc">Demonstrate military strength</div>
              <div class="desc">"Group A mobilizes security; we will not be pushed around."
              </div>
              <p class="signal">Signal: ready and firm (may escalate fear)</p>
            </div>
          </div>

          <div>
            <div class="section-label">Score</div>
            <div class="score-card">
              <div class="score-label">GROUP A (You)</div>
              <p class="score-value" id="score-a">0</p>
              <p class="score-round" id="score-a-round">This round: +0</p>
            </div>
            <div style="height: var(--s3);"></div>
            <div class="score-card red">
              <div class="score-label">GROUP B (Them)</div>
              <p class="score-value" id="score-b">0</p>
              <p class="score-round" id="score-b-round">This round: +0</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="end-screen" class="hidden">
      <div class="card" style="margin-bottom: var(--s4);">
        <h2 style="margin: 0 0 var(--s3);">Results ‚Äî Part II</h2>
        <div class="timeline" id="timeline"></div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--s3); margin-top: var(--s3);">
          <div class="end-card" id="final-a"></div>
          <div class="end-card" id="final-b"></div>
        </div>
        <div class="end-card" style="margin-top: var(--s4);" id="outcome-summary"></div>
        <div class="end-card" style="margin-top: var(--s3);" id="analysis-box"></div>

        <h3 style="margin-top: var(--s4);">Comparison with Part I</h3>
        <div class="insights">
          <div class="insight-box" style="border-top-color: var(--orange);">
            <strong>Noise breaks cooperation</strong>
            <p style="color: var(--muted); line-height: 1.6;">Even with good intentions, perceptions and misinformation can generate unexpected defensive responses. Peace requires managing uncertainty, not just sending good signals.</p>
          </div>
          <div class="insight-box" style="border-top-color: var(--red);">
            <strong>Trust is fragile under stress</strong>
            <p style="color: var(--muted); line-height: 1.6;">Risk of perceived betrayal increases with noise. Verification mechanisms and trusted channels reduce fear.</p>
          </div>
          <div class="insight-box" style="border-top-color: var(--green);">
            <strong>Cooperation still pays</strong>
            <p style="color: var(--muted); line-height: 1.6;">Although not guaranteed, consistent cooperation improves average outcomes under uncertainty.</p>
          </div>
        </div>

        <h3 style="margin-top: var(--s4);">Understanding the Noise</h3>
        <div class="end-card orange" style="margin-top: var(--s3);">
          <strong>What does "noise" really represent?</strong><br><br>
          In this game, "noise" models <strong>competing interests within each group</strong>. Group B didn't defect because of simple stubbornness‚Äîthey have:<br>
          ‚Ä¢ <strong>Hardliners</strong> in military/security pushing for mobilization<br>
          ‚Ä¢ <strong>Economic interests</strong> worried about appearing weak<br>
          ‚Ä¢ <strong>Constituency pressure</strong> from citizens who fear the other group<br>
          ‚Ä¢ <strong>Intelligence agencies</strong> with ambiguous assessments<br>
          ‚Ä¢ <strong>Opposition parties</strong> exploiting fear for political gain<br><br>
          Your gesture of dialogue is real, but it competes against these internal pressures. Group B's "irrational" response isn't irrational‚Äîit's rational given their internal constraints. Real peace requires understanding and addressing the internal actors fueling suspicion.
        </div>

        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--s3); margin-top: var(--s4);">
          <button class="btn" id="replay-btn">Replay Part II</button>
          <button class="btn btn-secondary" id="back-part1-btn-bottom">Back to Part I</button>
          <button class="btn btn-secondary" id="datalab-btn">Back to DataLab</button>
          <button class="btn btn-secondary" id="home-btn">Return to Home</button>
        </div>
      </div>
    </div>
  </div>

  <div class="outcome-modal" id="outcome-modal" aria-modal="true" role="dialog">
    <div class="outcome-content">
      <div id="outcome-badge" class="badge" style="background: var(--teal);">Result</div>
      <div id="outcome-title" class="status">Title</div>
      <p id="outcome-desc" style="line-height: 1.6; color: var(--text);"></p>
      <div id="outcome-points" class="outcome-points"></div>
      <button class="btn" id="next-round-btn">Next</button>
    </div>
  </div>

  <script>
    const beginBtn = document.getElementById('begin-btn');
    const backTopBtn = document.getElementById('back-part1-btn');
    const backBottomBtn = document.getElementById('back-part1-btn-bottom');
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const endScreen = document.getElementById('end-screen');
    const dialogueBtn = document.getElementById('dialogue-btn');
    const forceBtn = document.getElementById('force-btn');
    const roundIndicator = document.getElementById('round-indicator');
    const narrativeBox = document.getElementById('narrative-box');
    const historyList = document.getElementById('history-list');
    const scoreAEl = document.getElementById('score-a');
    const scoreBEl = document.getElementById('score-b');
    const scoreARound = document.getElementById('score-a-round');
    const scoreBRound = document.getElementById('score-b-round');
    const outcomeModal = document.getElementById('outcome-modal');
    const outcomeBadge = document.getElementById('outcome-badge');
    const outcomeTitle = document.getElementById('outcome-title');
    const outcomeDesc = document.getElementById('outcome-desc');
    const outcomePoints = document.getElementById('outcome-points');
    const nextRoundBtn = document.getElementById('next-round-btn');
    const timelineEl = document.getElementById('timeline');
    const finalA = document.getElementById('final-a');
    const finalB = document.getElementById('final-b');
    const outcomeSummary = document.getElementById('outcome-summary');
    const analysisBox = document.getElementById('analysis-box');
    const noiseExplanation = document.getElementById('noise-explanation');
    const whatActual = document.getElementById('what-actual');
    const whatBest = document.getElementById('what-best');
    const whatWorst = document.getElementById('what-worst');

    const TOTAL_ROUNDS = 5;
    const choicesMap = { dialogue: 'üïäÔ∏è', showForce: '‚ö°' };

    const OPP_PARAMS = { pCoopAfterA: 0.6, pCoopAfterForce: 0.2, misperceptionShock: 0.35 };
    const state = { round: 1, userScore: 0, oppScore: 0, userChoices: [], oppChoices: [], history: [], lastRoundPoints: { a: 0, b: 0 } };

    beginBtn.addEventListener('click', () => { startScreen.classList.add('hidden'); gameScreen.classList.remove('hidden'); updateUI(); });
    backTopBtn.addEventListener('click', () => { window.location.href = 'prisoners_dilemma_escalation.html'; });
    dialogueBtn.addEventListener('click', () => handleChoice('dialogue'));
    forceBtn.addEventListener('click', () => handleChoice('showForce'));

    nextRoundBtn.addEventListener('click', () => {
      outcomeModal.style.display = 'none';
      if (state.round > TOTAL_ROUNDS) { showEndScreen(); } else { updateUI(); }
    });

    backBottomBtn.addEventListener('click', () => { window.location.href = 'prisoners_dilemma_escalation.html'; });
    document.getElementById('datalab-btn').addEventListener('click', () => { window.location.href = 'data-lab.html'; });
    document.getElementById('home-btn').addEventListener('click', () => { window.location.href = 'index.html'; });

    function handleChoice(userChoice) {
      const opponentChoice = getOpponentChoice(state.round, state.userChoices);
      state.userChoices.push(userChoice);
      state.oppChoices.push(opponentChoice);
      const { userPoints, oppPoints, outcome } = evaluateRound(userChoice, opponentChoice);
      state.userScore += userPoints;
      state.oppScore += oppPoints;
      state.lastRoundPoints = { a: userPoints, b: oppPoints };
      state.history.push({ round: state.round, userChoice, opponentChoice, outcome, userPoints, oppPoints });
      showOutcomeModal(outcome, userPoints, oppPoints);
      state.round += 1;
    }

    function getOpponentChoice(round, userChoiceHistory) {
      if (round === 1) return Math.random() < 0.5 ? 'dialogue' : 'showForce';
      const lastA = userChoiceHistory[userChoiceHistory.length - 1];
      // Misperception shock: sometimes defensive response despite cooperation
      if (Math.random() < OPP_PARAMS.misperceptionShock) return 'showForce';
      if (lastA === 'showForce') {
        return Math.random() < (1 - OPP_PARAMS.pCoopAfterForce) ? 'showForce' : 'dialogue';
      }
      return Math.random() < OPP_PARAMS.pCoopAfterA ? 'dialogue' : 'showForce';
    }

    function evaluateRound(userChoice, opponentChoice) {
      const matrix = { dialogue: { dialogue: [3,3], showForce: [0,5] }, showForce: { dialogue: [5,0], showForce: [1,1] } };
      const [userPoints, oppPoints] = matrix[userChoice][opponentChoice];
      let outcome = {};
      if (userChoice === 'dialogue' && opponentChoice === 'dialogue') {
        outcome = { title: '‚úÖ Cooperation under uncertainty', desc: 'Despite the noise, both groups chose dialogue. A window opens for de-escalation.', badge: varColor('green'), path: 'coop' };
      } else if (userChoice === 'dialogue' && opponentChoice === 'showForce') {
        outcome = { title: '‚ö†Ô∏è Mistrust breaks dialogue', desc: 'You sought dialogue, but Group B reacted with force out of fear or misinformation. You must decide whether to persist or respond.', badge: varColor('red'), path: 'mixed' };
      } else if (userChoice === 'showForce' && opponentChoice === 'dialogue') {
        outcome = { title: '‚úÖ Leverage with costs', desc: 'Your show of force led B to dialogue, but increases risk of future misinterpretations.', badge: varColor('orange'), path: 'mixed' };
      } else {
        outcome = { title: '‚ùå Escalation under noise', desc: 'Both groups mobilized forces. With noise, incidents and accidents become more likely.', badge: varColor('deep-red'), path: 'escalate' };
      }
      return { userPoints, oppPoints, outcome };
    }

    function varColor(key) { const map = { green: 'var(--green)', red: 'var(--red)', orange: 'var(--orange)', teal: 'var(--teal)', 'deep-red': 'var(--deep-red)' }; return map[key] || 'var(--teal)'; }

    function showOutcomeModal(outcome, userPoints, oppPoints) {
      outcomeBadge.style.background = outcome.badge;
      outcomeTitle.textContent = outcome.title;
      outcomeDesc.textContent = outcome.desc;
      outcomePoints.textContent = `You +${userPoints} | Them +${oppPoints}`;
      outcomeModal.style.display = 'flex';
    }

    function updateUI() {
      roundIndicator.textContent = `Round ${state.round} of ${TOTAL_ROUNDS}`;
      narrativeBox.textContent = getNarrative(state.round);
      renderHistory();
      renderScores();
      dialogueBtn.classList.remove('choice-selected-dialogue');
      forceBtn.classList.remove('choice-selected-force');
    }

    function renderHistory() {
      historyList.innerHTML = '';
      state.history.forEach(entry => {
        const item = document.createElement('div');
        item.className = 'history-item';
        const borderColor = entry.userChoice === entry.opponentChoice ? (entry.userChoice === 'dialogue' ? varColor('green') : varColor('red')) : varColor('orange');
        item.style.borderLeftColor = borderColor;
        item.innerHTML = `
          <strong>Round ${entry.round}:</strong><br>
          You ‚Üí ${choicesMap[entry.userChoice]} ${entry.userChoice === 'dialogue' ? 'DIALOGUE' : 'FORCE'}<br>
          Them ‚Üí ${choicesMap[entry.opponentChoice]} ${entry.opponentChoice === 'dialogue' ? 'DIALOGUE' : 'FORCE'}<br>
          Result: +${entry.userPoints} for you, +${entry.oppPoints} for them
        `;
        historyList.prepend(item);
      });
    }

    function renderScores() {
      scoreAEl.textContent = state.userScore;
      scoreBEl.textContent = state.oppScore;
      scoreARound.textContent = `This round: +${state.lastRoundPoints.a}`;
      scoreBRound.textContent = `This round: +${state.lastRoundPoints.b}`;
    }

    function getNarrative(round) {
      if (round === 1) return 'The situation includes information noise and ambiguous signals. Group B can react defensively even to peace offers. What does Group A do?';
      const last = state.history[state.history.length - 1];
      const mutualDialogue = last.userChoice === 'dialogue' && last.opponentChoice === 'dialogue';
      const mutualEscalation = last.userChoice === 'showForce' && last.opponentChoice === 'showForce';

      const round3A = 'Talks advance, but rumors threaten the process. Verification and transparency are key. What does Group A do?';
      const round4A = 'A monitoring mechanism is established to reduce misinformation. Cooperation is fragile but possible. What does Group A do?';
      const round5A = 'Final decision: consolidating peace under uncertainty requires sustained commitment and trusted channels. What does Group A do?';

      const round3B = 'Checkpoints harden. A misunderstanding triggered extra mobilization. What does Group A do?';
      const round4B = 'An accidental incident raises tension. Mediators try to calm things. What does Group A do?';
      const round5B = 'On the edge with noise. One wrong move starts total conflict. What does Group A do?';

      const round3C = 'Trust oscillates. You need consistent signals and verification. What does Group A do?';
      const round4C = 'The cost of stalemate grows. Without trusted channels, fear dominates. What does Group A do?';
      const round5C = 'Last chance: invest in trust or remain trapped in the spiral. What does Group A do?';

      if (mutualDialogue) {
        if (round === 2) return 'Good news: there are talks, but noise makes them fragile. What does Group A do?';
        if (round === 3) return round3A; if (round === 4) return round4A; return round5A;
      }
      if (mutualEscalation) {
        if (round === 2) return 'Military spending rises and rumors worsen perceptions. What does Group A do?';
        if (round === 3) return round3B; if (round === 4) return round4B; return round5B;
      }
      if (round === 2) return 'Your peace offer was seen as weakness. B mobilized out of fear. Do you insist or respond?';
      if (round === 3) return round3C; if (round === 4) return round4C; return round5C;
    }

    function showEndScreen() {
      gameScreen.classList.add('hidden');
      endScreen.classList.remove('hidden');
      const timelineStr = state.history.map(h => `Round ${h.round}: ${choicesMap[h.userChoice]}‚Üí${choicesMap[h.opponentChoice]}`).join(' | ');
      timelineEl.textContent = timelineStr;
      finalA.innerHTML = `<strong>GROUP A (You)</strong><br><span style="color: var(--teal); font-size: 22px; font-weight: 700;">${state.userScore}</span> points`;
      finalB.innerHTML = `<strong>GROUP B (Them)</strong><br><span style="color: var(--red); font-size: 22px; font-weight: 700;">${state.oppScore}</span> points`;

      const outcomeType = classifyOutcome();
      outcomeSummary.innerHTML = `<strong>Result:</strong> ${outcomeType.outcome}<br><strong>Stability:</strong> ${outcomeType.stability}<br><strong>Narrative:</strong> ${outcomeType.narrative}`;

      analysisBox.innerHTML = escalationOccurred() ? `
        <strong>Why did this happen?</strong><br><br>
        Noise and misinformation amplified fear. Even with cooperation, threats were perceived. Without trusted channels, the security dilemma intensifies.
      ` : `
        <strong>Why did this happen?</strong><br><br>
        You sustained cooperation under uncertainty. Verification and consistency were key to avoiding misunderstandings.
      `;

      noiseExplanation.innerHTML = `
        <strong>What does "noise" really represent?</strong><br><br>
        In this game, "noise" models <strong>competing interests within each group</strong>. Group B didn't defect because of simple stubbornness‚Äîthey have:<br>
        ‚Ä¢ <strong>Hardliners</strong> in military/security pushing for mobilization<br>
        ‚Ä¢ <strong>Economic interests</strong> worried about appearing weak<br>
        ‚Ä¢ <strong>Constituency pressure</strong> from citizens who fear the other group<br>
        ‚Ä¢ <strong>Intelligence agencies</strong> with ambiguous assessments<br>
        ‚Ä¢ <strong>Opposition parties</strong> exploiting fear for political gain<br><br>
        Your gesture of dialogue is real, but it competes against these internal pressures. Group B's "irrational" response isn't irrational‚Äîit's rational given their internal constraints. Real peace requires understanding and addressing the internal actors fueling suspicion.
      `;

      const actualSeq = timelineStr;
      const bestSeq = 'üïäÔ∏è‚ÜíüïäÔ∏è | üïäÔ∏è‚ÜíüïäÔ∏è | üïäÔ∏è‚ÜíüïäÔ∏è | üïäÔ∏è‚ÜíüïäÔ∏è | üïäÔ∏è‚ÜíüïäÔ∏è';
      const worstSeq = '‚ö°‚Üí‚ö° | ‚ö°‚Üí‚ö° | ‚ö°‚Üí‚ö° | ‚ö°‚Üí‚ö° | ‚ö°‚Üí‚ö°';
      whatActual.innerHTML = `<strong>What happened</strong><br>${actualSeq}<br>You ${state.userScore} pts | Them ${state.oppScore} pts`;
      whatBest.innerHTML = `<strong>Best case (Mutual cooperation)</strong><br>${bestSeq}<br>You 15 pts | Them 15 pts`;
      whatWorst.innerHTML = `<strong>Worst case (Mutual escalation)</strong><br>${worstSeq}<br>You 5 pts | Them 5 pts`;
    }

    function classifyOutcome() {
      const allDialogue = state.history.every(h => h.userChoice === 'dialogue' && h.opponentChoice === 'dialogue');
      const allEscalation = state.history.every(h => h.userChoice === 'showForce' && h.opponentChoice === 'showForce');
      const dialogueCount = state.history.filter(h => h.userChoice === 'dialogue' && h.opponentChoice === 'dialogue').length;
      const forceCount = state.history.filter(h => h.userChoice === 'showForce' && h.opponentChoice === 'showForce').length;
      const last = state.history[state.history.length - 1];
      const lastMutualDialogue = last.userChoice === 'dialogue' && last.opponentChoice === 'dialogue';
      const lastMutualForce = last.userChoice === 'showForce' && last.opponentChoice === 'showForce';

      if (allDialogue) return { outcome: 'Peace achieved under noise', stability: 'High but fragile', narrative: 'Cooperation withstood uncertainty.' };
      if (allEscalation) return { outcome: 'Escalation to conflict', stability: 'Null', narrative: 'Noise amplified mutual fear and both lost.' };
      if (dialogueCount > forceCount && lastMutualForce) return { outcome: 'Peace collapsed by misunderstanding', stability: 'Deterioration', narrative: 'Trust was insufficient to resist noise.' };
      if (forceCount > dialogueCount && lastMutualDialogue) return { outcome: 'De-escalation at the edge', stability: 'Uncertain', narrative: 'Dialogue achieved despite negative perceptions.' };
      return { outcome: 'Oscillation under uncertainty', stability: 'Unstable', narrative: 'Without verification, distrust dominates the cycle.' };
    }

    function escalationOccurred() { return state.history.some(h => h.userChoice === 'showForce' || h.opponentChoice === 'showForce'); }

    function resetGame() {
      Object.assign(state, { round: 1, userScore: 0, oppScore: 0, userChoices: [], oppChoices: [], history: [], lastRoundPoints: { a: 0, b: 0 } });
      endScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');
      updateUI();
    }

    // Buttons
    document.getElementById('replay-btn').addEventListener('click', resetGame);
  </script>
</body>
</html>
